ข้อนี้เป็นโจทย์ Combinatorics ที่ต้องใช้ความสามารถในการคิดพลิกแพลงค่อนข้างมาก เราสามารถคิดสูตรได้หลายวิธี แต่ในที่นี้จะกล่าวถึงวิธีที่ผู้เขียนเห็นว่าเข้าใจได้ง่ายที่สุด

ให้ $R$ แทนจำนวนไม้ที่ทาสีแดง, $Y$ แทนจำนวนไม้ที่ทาสีเหลือง, $W$ แทนจำนวนไม้ที่ทาสีขาว,  และ $B$ แทนจำนวนไม้ที่ทาสีน้ำเงิน โจทย์กำหนดให้ $R=Y$, $W=B$ และ $R+Y+W+B = 2N$ จะได้ว่า

1. $R+W = N$
2. $Y+B = N$
3. $R+B=N$
4. $Y+W=N$

จากสองความสัมพันธ์แรก เราตัดสินใจ**แบ่งไม้ $2N$ แท่งออกเป็นสองกอง กองละ $N$ แท่ง** โดยกองแรกคือไม้ที่เราจะทาสีแดงหรือสีขาว ($R+W$) ส่วนกองที่สองคือสีเหลืองหรือสีน้ำเงิน ($Y+B$) การแบ่งดังกล่าวสามารถทำได้ทั้งหมด ${2N \choose N}$ วิธี (เลือกไม้ $N$ แท่งจาก $2N$ แท่งมาไว้กองแรก ส่วนที่เหลือจะอยู่กองที่สองโดยอัตโนมัติ)

ในทำนองเดียวกัน เราสามารถแบ่งไม้ $2N$ แท่งออกเป็นสองกองตามสองความสัมพันธ์สุดท้าย นั่นคือกองแรกคือไม้ที่จะทาสีแดงหรือสีน้ำเงิน $N$ แท่ง และอีกกองคือไม้ที่จะทาสีเหลืองหรือสีขาว $N$ แท่ง ทำได้ ${2N \choose N}$ วิธีเช่นกัน

หากพิจารณาการแบ่งทั้งสองกรณี จะเห็นได้ว่าไม้ทุกแท่งจะได้รับการกำหนดสีที่จะทา แท่งละ 1 สีพอดี โดยการลงสีจะตรงตามความสัมพันธ์ในสมการข้างต้น

เนื่องจากการแบ่งไม้ทั้งสองครั้งเป็นอิสระต่อกัน ดังนั้นจำนวนวิธีแบ่งทั้งหมดจึงเท่ากับ $${2N \choose N}^2$$

โจทย์กำหนดให้ตอบใน modulo $M$ ดังนั้น เราจึงควรหาวิธีคำนวณ ${2N \choose N} \bmod M$ ให้ได้ก่อน แล้วจึงนำไปยกกำลังสอง ตอบใน mod $M$

เราไม่สามารถคำนวณด้วยสูตร $${2N \choose N} = \frac{(2N)!}{N!N!}$$ ได้อย่างง่ายดาย เพราะเราไม่สามารถดำเนินการหารในระบบ modulo ได้ เว้นแต่ว่า $M$ เป็นจำนวนเฉพาะเราอาจจะใช้ multiplicative inverse ในการคำนวณ

เราทราบว่า $\frac{(2N)!}{N!N!}$ ได้คำตอบเป็นจำนวนเต็มลงตัวแน่นอน ดังนั้นวิธีการคำนวณที่ง่ายที่สุดคือการแจกแจงแต่ละพจน์ออกมาแล้วแยกตัวประกอบเฉพาะ ตัวประกอบจะตัดกันจนตัวหารเหลือเพียง $1$ ทำให้เราสามารถคำนวณ $\frac{(2N)!}{N!N!}$ ได้ด้วยการคูณเพียงอย่างเดียว

การแยกตัวประกอบตัวตั้งอาจทำได้ดังนี้
1. ใช้ sieve of erathosthenes เพื่อหาว่า สำหรับจำนวนเต็ม $x$ ที่ $2 \leq x \leq 2N$, $x$ เป็นจำนวนเฉพาะหรือไม่ และถ้า $x$ ไม่เป็นจำนวนเฉพาะ ตัวหารหนึ่งที่เป็นไปได้คืออะไร
    - เพื่อความสะดวก จะเรียกตัวหาร (ตัวใดก็ได้) ของ $x$ ว่า $d_x$
    - สังเกตว่า $x = (d_x)(\frac{x}{d_x})$
2. สร้าง array $A$ ขึ้นมาเพื่อเก็บว่าสามารถแยกตัวประกอบเฉพาะของ $(2N)!$ ได้อย่างไร ในตอนแรกกำหนดให้ $A_x=1$ สำหรับทุก $x$ ที่ $2 \leq x \leq 2N$
    - $A$ จะสื่อถึงว่า $2N = 2^{A_2} 3^{A_3} 4^{A_4} \cdots (2N)^{A_{2N}}$
    - ในตอนนี้ $2N = 2^1 3^1 4^1 \cdots (2N)^1$
3. พิจารณา $x=2N$ ไล่ลงมาถึง $x=2$ ถ้า $x$ เป็นจำนวนประกอบ ให้เพิ่มค่า $A_{d_x}$ และ $A_{x/d_x}$ ไป $A_x$ แล้วปรับให้ $A_x = 0$
    - เปรียบเสมือนการแยกพจน์ $(d_x \frac{x}{d_x})^{A_x}$ ออกเป็นพจน์ $(d_x)^{A_x}$ คูณกับ $(\frac{x}{d_x})^{A_x}$

ในตอบจบเราจะได้การแยกตัวประกอบเฉพาะของ $2N$ เป็น $2^{A_2} 3^{A_3} 5^{A_5} 7^{A_7} \cdots$

ทำในทำนองเดียวกันกับตัวหาร แล้วจึงนำแต่ละพจน์หารกันจนตัวหารเหลือเลขชี้กำลังทุกตำแหน่งเป็น $0$ (ตัวหาร = $1$) สุดท้ายนำการแยกตัวประกอบเฉพาะของตัวตั้งกลับมาคูณกันให้เป็นจำนวนเต็มใน modulo $M$

อย่าลืมว่าคำตอบสุดท้ายต้องนำไปยกกำลังสองด้วย: $\left(\frac{(2N)!}{N!N!}\right)^2$
